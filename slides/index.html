<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Microservice'ing like a Unicorn with Kubernetes, Envoy, and Istio</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/beige.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
		<style>
			.reveal section img.no-border{
				border: 0px;
				box-shadow: none;
			}

			.reveal p.left-align {
				margin: 20px 100px;
				line-height: 1.3;
				text-align: left;
			}

		</style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section id="title">
					<h3>Microservice'ing like a unicorn</h3>
					<h4>with Kubernetes, Envoy, and Istio</h4>
					<div align="center">
						<img src="images/unicorn.png"/>
					</div>
					<p>
						<small>Created by <a href="http://twitter.com/christianposta">@christianposta</a> and <a href="https://github.com/christian-posta/istio-workshop/graphs/contributors">contributors</a></small>
					</p>
				</section>
				<section id="agenda">
					<h2>Agenda</h2>
					<ul>
						<li>How did we get here?</li>
						<li>Meet Envoy Proxy</li>
						<li>Istio Service Mesh</li>
						<li>Resilience</li>
						<li>Routing</li>
						<li>Observability</li>
						<li>Chaos Testing</li>
						<li>API Management</li>
					</ul>
				</section>

				<!--How did we get here------------------------------------------------------------------>
				<section>
					<section>
						<h3>How did we get here</h3>

						<aside class="notes">
							Let's talk about some of the drivers of how we got here
						</aside>
					</section>


					<section>
						<h3>so you want a services architecture...</h3>
						<img src="images/openquote.png" class="no-border" height="50" width="75"/>
						<blockquote>"do one thing, do it well"</blockquote>
						<blockquote>"pick right technology for the problem"</blockquote>
						<blockquote>"individual deployment"</blockquote>
					</section>


					<section>
						<h3>Kubernetes to the rescue!</h3>
						<img src="images/little-kube.png" height="300" width="300" class="no-border"/>
					</section>


					<section>
						<p>Kubernetes is a deployment platform; <br/>it does not address service communication</p>
					</section>


					<section>
						<p>the network is <i>not</i> reliable</p>
						<small>
							<a href="https://en.wikipedia.org/wiki/Fallacies_of_distributed_computing">fallacies of distributed computing</a>
						</small>
						<aside class="notes">
							The network is reliable.
							Latency is zero.
							Bandwidth is infinite.
							The network is secure.
							Topology doesn't change.
							There is one administrator.
							Transport cost is zero.
							The network is homogeneous.
						</aside>
					</section>


					<section>
						<h3>can kubernetes help?</h3>
						<ul>
							<li>DNS based service discovery</li>
							<li>simple L3/4 load balancing</li>
						</ul>
					</section>



					<section>
						<h4>every application must account for</h4>
						<ul>
							<li>unpredictable failure modes</li>
							<li>end-to-end application correctness</li>
							<li>system degradation</li>
							<li>topology changes</li>
							<li>elastic/ephemeral/transient resources</li>
						</ul>
					</section>




					<section>
						<p>so we do things like...</p>
						<ul>
							<li>circuit breaking</li>
							<li>bulkheading</li>
							<li>timeouts</li>
							<li>retries</li>
							<li>service discovery</li>
							<li>client-side loadbalancing</li>
						</ul>
					</section>


					<section>
						<p class="left-align">actually, entire suites of frameworks
							were built to help	developers address these
							resilience concerns
						</p>
						<img src="images/finagle.png" class="no-border"/>
						<img src="images/netflixoss.png" class="no-border"/>

					</section>


					<section>
						<img src="images/netflixoss2.png" class="no-border"/>
						<br/>
						<ul>
							<li>Hystrix</li>
							<li>Zuul</li>
							<li>Ribbon</li>
							<li>Eureka</li>
							<li>Brave/Zipkin</li>
							<li>Spector/Atlas</li>
						</ul>
					</section>



					<section>
						<img src="images/network-commingled.png"/>
					</section>


					<section>
						<h3>but i'm using spring!</h3>
						<ul>
							<li>spring-cloud-netflix-hystrix</li>
							<li>spring-cloud-netflix-zuul</li>
							<li>spring-cloud-netflix-eureka-client</li>
							<li>spring-cloud-netflix-ribbon</li>
							<li>spring-cloud-netflix-atlas</li>
							<li>spring-cloud-netflix-spectator</li>
							<li>spring-cloud-netflix-hystrix-stream</li>
							<li>...</li>
							<li><i>@Enable....150differentThings</i></li>

						</ul>
					</section>


					<section>
						<h3>but i'm using vert.x</h3>
						<ul>
							<li>vertx-circuit-breaker</li>
							<li>vertx-service-discovery</li>
							<li>vertx-dropwizard-metrics</li>
							<li>vertx-zipkin</li>
							<li>...</li>
						</ul>
					</section>


					<section>
						<h3>but i'm using...</h3>
						<ul>
							<li class="fragment">NodeJS</li>
							<li class="fragment">Go</li>
							<li class="fragment">Python</li>
							<li class="fragment">Ruby</li>
							<li class="fragment">Perl</li>
							<li class="fragment">Get the point!?</li>
						</ul>
					</section>


					<section>
						<p class="left-align">so for every language/framework combination, you need...</p>
						<ul>
							<li>service discovery</li>
							<li>retries</li>
							<li>timeouts</li>
							<li>load balancing</li>
							<li>bulk heading</li>
							<li>circuit breaking</li>
							<li>rate limiting</li>
						</ul>
					</section>


					<section>
						<p class="left-align">so for every language/framework combination, you need...</p>
						<ul>
							<li>adaptive routing</li>
							<li>deadlines</li>
							<li>back pressure</li>
							<li>outlier detection</li>
							<li>health checking</li>
							<li>traffic shaping</li>
							<li>request shadowning</li>
						</ul>
					</section>


					<section>
						<p class="left-align">so for every language/framework combination, you need...</p>
						<ul>
							<li>edge/dmz routing</li>
							<li>surgical / fine / per-request routing</li>
							<li>A/B testing rollout</li>
							<li>dark launches</li>
							<li>fault injection</li>
							<li>stats, metric collection</li>
							<li>observability</li>
						</ul>
					</section>


					<section>
						<h3>drawbacks to library approach</h3>
						<ul>
							<li>need one for each combination language/framework</li>
							<li>need to maintain, upgrade, retire</li>
							<li>classpath/namespace pollution</li>
							<li>increases operational complexity</li>
							<li>force specific languages</li>
							<li>inconsistency</li>
							<li>correctness</li>
						</ul>
					</section>

					<section>
						<p>what if we could implement it once, in one spot, and let any language use it?</p>
						<img src="images/serviceproxy.png"/>
					</section>

				</section>

				<!--Meet Envoy Proxy------------------------------------------------------------------>
				<section>
					<section>
						<h3>Meet Envoy Proxy</h3>
						<div align="center">
							<a href="https://www.envoyproxy.io">https://www.envoyproxy.io</a>
						</div>
						<div align="center">
							<img src="images/envoylogo.png"/>
						</div>
					</section>


					<section>
						<h3>Wait: what is Envoy?</h3>
						<ul>
							<li>service proxy</li>
							<li>written in C++, highly parallel, non-blocking</li>
							<li>L3/4 network filter</li>
							<li>out of the box L7 filters</li>
							<li>HTTP 2, including gRPC</li>
							<li>baked in service discvoery/health checking</li>
							<li>advanced load balancing</li>
							<li>stats, metrics, tracing</li>
							<li>dynamic configuration through xDS</li>

						</ul>

						<div>
							<small>See more here: <br/>
							<a href="https://www.slideshare.net/datawire/lyfts-envoy-from-monolith-to-service-mesh-matt-klein-lyft/12">From Monolith to ServiceMesh - Matt Klein, Lyft</a> </small>
						</div>
					</section>


					<section>
						<img src="images/thatsenvoy.png"/>
					</section>


					<section>
						<h3>Envoy as edge proxy</h3>
						<img src="images/envoyedge.png"/>
					</section>


					<section>
						<h3>Envoy as shared proxy</h3>
						<img src="images/envoyshared.png"/>
					</section>



					<section>
						<h3>Envoy as sidecar proxy</h3>
						<img src="images/envoysidecar.png"/>
					</section>


					<section>
						<h3>sidecar proxy</h3>
						<img src="images/envoyarch.png"/>
					</section>


					<section>
						<h3>Dealing with network traffic</h3>
						<ul>
							<li>zone aware, least request load balancing</li>
							<li>circuit breaking</li>
							<li>outlier detection</li>
							<li>retries, retry policies</li>
							<li>timeout (including budgets)</li>
							<li>traffic shadowing</li>
							<li>rate limiting</li>
							<li>access logging, statistics collection</li>
						</ul>

						<div>
							<small>See more here: <br/>
								<a href="https://www.slideshare.net/datawire/lyfts-envoy-from-monolith-to-service-mesh-matt-klein-lyft/17">From Monolith to ServiceMesh - Matt Klein, Lyft</a> </small>
						</div>
					</section>


					<section>
						<p>let's get some hands on...</p>
					</section>
				</section>


				<section>
					<section>
						<h3>Hands on with Envoy Proxy</h3>
					</section>


					<section>
						<h3>Prerequisites for hands-on</h3>
						<ul>
							<li>docker cli/client</li>
							<li>access to docker daemon</li>
							<li>network connection to <a href="http://hub.docker.io">hub.docker.io</a></li>
						</ul>
						<small>I'm using <a href="https://github.com/kubernetes/minikube">minikube</a>/<a href="https://www.openshift.org/minishift/">minishift</a>. YMMV</small>
					</section>


					<section>
						<h3>Pull some images</h3>
						<blockquote>
							docker pull envoyproxy/envoy
						</blockquote>
						<blockquote>
							docker pull tutum/curl
						</blockquote>
						<blockquote>
							docker pull citizenstig/httpbin
						</blockquote>
					</section>

					<section data-markdown>
						<script type="text/template">
							### Start a simple service

							```
							$  docker run -it --name httpbin --rm citizenstig/httpbin
							```

							### Verify service works

							```
							$  docker run -it --link httpbin tutum/curl \
							curl -X GET http://httpbin:8000/headers

							{
							  "headers": {
							    "Accept": "*/*",
							    "Host": "httpbin:8000",
							    "User-Agent": "curl/7.35.0"
							  }
							}
							```

						</script>
					</section>


					<section data-markdown>
						<script type="text/template">
							### Checkout Envoy!

							```
							$  docker run -it envoyproxy/envoy envoy --help
							```

							### Try running

							```
							$  docker run -it envoyproxy/envoy envoy

							[2017-11-29 23:37:44.748][1][info][main] source/server/server.cc:157]
								initializing epoch 0 (hot restart version=9.200.16384.127)
							[2017-11-29 23:37:44.749][1][critical][main] source/server/server.cc:71]
								error initializing configuration '': unable to read file:


							```

							Damn! No config file!

						</script>
					</section>


					<section data-markdown>
						<script type="text/template">
							### Envoy config file
							```
							{
							  "listeners": "tcp://0.0.0.0:15001",
							  "filters": [ .... ],
							  "admin": {
							    ...
							  },
							  "cluster_manager": {
							    "clusters": {
							       "name": "foo_service",
							       "type": "logical_dns",
							       "lb_type": "round_robin",
							       "hosts": [ ... ]
							    }
							  }
							```

							[See the Envoy docs for more detail](https://www.envoyproxy.io/docs/envoy/latest/intro/intro)
						</script>
					</section>


					<section>
						<h3>Our sample envoy config file</h3>
						<a href="https://github.com/christian-posta/istio-workshop/blob/master/envoy/conf/simple.json" target="_blank">
							https://github.com/christian-posta/istio-workshop/blob/master/envoy/conf/simple.json
						</a>
					</section>


					<section data-markdown>
						<script type="text/template">
							### Let's run with a configuration file

							```
							$  docker run -it --name proxy --link httpbin \
							-v $(pwd)/envoy/conf/simple.json:/etc/simple.json \
							envoyproxy/envoy envoy -c /etc/simple.json

							[2017-11-30 14:05:03.047][1][info][main] source/server/server.cc:157]
							  initializing epoch 0 (hot restart version=9.200.16384.127)
							[2017-11-30 14:05:03.061][1][info][config]
							  source/server/configuration_impl.cc:45] loading 1 listener(s)
							[2017-11-30 14:05:03.070][1][info][config]
							  source/server/configuration_impl.cc:83] loading tracing configuration
							[2017-11-30 14:05:03.070][1][info][config]
							  source/server/configuration_impl.cc:109] loading stats sink configuration
							[2017-11-30 14:05:03.071][1][info][main] source/server/server.cc:348]
							  starting main dispatch loop
							[2017-11-30 14:05:03.075][1][info][upstream]
							  source/common/upstream/cluster_manager_impl.cc:131] cm init: all clusters initialized
							[2017-11-30 14:05:03.075][1][info][main]
							  source/server/server.cc:332] all clusters initialized. initializing init manager
							[2017-11-30 14:05:03.075][1][info][config]
							  source/server/listener_manager_impl.cc:482] all dependencies initialized. starting workers
							```
						</script>
					</section>


					<section>
						<p>now we have a sample service and an envoy proxy configured to forward requests to it</p>
						<img src="images/envoy-httpbin.png"/>
					</section>

					<section data-markdown>
						<script type="text/template">
							### Let's curl the proxy

							```
							$  docker run -it --link proxy tutum/curl \
							curl  -X GET http://proxy:15001/headers
							```
						</script>
					</section>


					<section data-markdown>
						<script type="text/template">
							### Response

							note the [X-Request-Id](https://www.envoyproxy.io/docs/envoy/latest/configuration/http_conn_man/headers.html#config-http-conn-man-headers-x-request-id)

							```
							{
							  "headers": {
							    "Accept": "*/*",
							    "Content-Length": "0",
							    "Host": "httpbin",
							    "User-Agent": "curl/7.35.0",
							    "X-Request-Id": "ef264545-4ba6-4865-8172-f9cadcb74e31"
							  }
							}
							```
						</script>
					</section>


					<section data-markdown>
						<script type="text/template">
							### Admin stats

							Let's curl the admin stats API

							```
							$  docker run -it --link proxy tutum/curl \
							curl -X GET http://proxy:15000/stats
							```



						</script>
					</section>

					<section data-markdown>
						<script type="text/template">
							### Admin stats

							Wow, that's a lot of good info! Let's trim it down:

							```
							$  docker run -it --link proxy tutum/curl \
							curl -X GET http://proxy:15000/stats | grep retry

							cluster.httpbin_service.retry_or_shadow_abandoned: 0
							cluster.httpbin_service.upstream_rq_retry: 0
							cluster.httpbin_service.upstream_rq_retry_overflow: 0
							cluster.httpbin_service.upstream_rq_retry_success: 0
							```
						</script>
					</section>


					<section data-markdown>
						<script type="text/template">
							### Retries

							Let's add some retry semantics to `httpbin_service`

							```
							"routes": [
							  {
							    "timeout_ms": 0,
							    "prefix": "/",
							    "auto_host_rewrite": true,
							    "cluster": "httpbin_service",
							    "retry_policy": {
							        "retry_on": "5xx",
							        "num_retries": 3
							    }
							}
							```
						</script>
					</section>


					<section>
						<section data-markdown>
							<script type="text/template">
								### Refresh with new config

								Restart our envoy proxy:

								```
								$  docker rm -f proxy
								$  docker run -it --name proxy --link httpbin \
								-v $(pwd)/envoy/conf/simple.json:/etc/simple.json \
								envoyproxy/envoy envoy -c /etc/simple.json
								```
							</script>
						</section>
					</section>


					<section>
						<section data-markdown>
							<script type="text/template">
								### Call an endpoint in error

								Curl the proxy to generate a `500`

								```
								$  docker run -it --link proxy tutum/curl \
								curl -X GET http://proxy:15001/status/500
								```

								Review the envoy admin stats:

								```
								$  docker run -it --link proxy tutum/curl \
								curl -X GET http://proxy:15000/stats | grep retry

								cluster.httpbin_service.retry.upstream_rq_500: 3
								cluster.httpbin_service.retry.upstream_rq_5xx: 3
								cluster.httpbin_service.retry_or_shadow_abandoned: 0
								cluster.httpbin_service.upstream_rq_retry: 3
								cluster.httpbin_service.upstream_rq_retry_overflow: 0
								cluster.httpbin_service.upstream_rq_retry_success: 0
								```
							</script>
						</section>
					</section>


					<section data-markdown>
						<script type="text/template">
							### Envoy config: circuit breaking

							```
							"cluster_manager": {
							  "clusters": [
								{
								  "name": "httpbin_service",
								  "hosts": [
									{
									  "url": "tcp://httpbin.org:80"
									}
								  ],
								  "circuit_breakers": {
									"default": {
									  "max_connections": 1,
									  "max_pending_requests": 1,
									  "max_retries": 3
									}
								  },

								 ...

								 }
							```
						</script>
					</section>


					<section data-markdown>
						<script type="text/template">
							### Envoy config: outlier detection

							```
							{
							  "name": "httpbin_service",
							  ...
							  "circuit_breakers": {
							    "default": {
							      "max_connections": 1,
							      "max_pending_requests": 1,
							      "max_retries": 3
							    }
							  },
							  "outlier_detection" : {
							    "consecutive_5xx": 5,
							    "max_ejection_percent": 100,
							    "interval_ms": 3000
							  }
							}
							```
						</script>
					</section>


					<section data-markdown>
						<script type="text/template">
							### Envoy config: load balancing

							`lb_type`:

							* round_robin
							* least_request
							* ring_hash
							* random
							* original_dst_lb

							```
							{
							  "name": "httpbin_service",
							    ...
							  "lb_type": "...",
							  "ring_hash_lb_config": { ... }

							}
							```
						</script>
					</section>


					<section data-markdown>
						<script type="text/template">
							### Envoy config: traffic shifting

							```
							"routes": [
							  {
							    "prefix": "/",
							    "cluster": "helloworld_v1",
							    "runtime": {
							      "key": "routing.traffic_shift.helloworld",
							      "default": 50
							     }
							    },
							  {
							    "prefix": "/",
							    "cluster": "helloworld_v2",
							  }
							```
						</script>
					</section>


					<section data-markdown>
						<script type="text/template">
							### Envoy config: traffic shifting

							```
							"weighted_clusters": {
							  "runtime_key_prefix" : "routing.traffic_split.helloworld",
							  "clusters" : [
							    { "name" : "helloworld_v1", "weight" : 33 },
							    { "name" : "helloworld_v2", "weight" : 33 },
							    { "name" : "helloworld_v3", "weight" : 34 }
							  ]
							```
						</script>
					</section>


					<section data-markdown>
						<script type="text/template">
							### Envoy resource consumption

							```
							$  docker top proxy

							PID      USER         COMMAND
							4997     root         envoy -c /etc/simple.json

							$  docker stats proxy

							CONTAINER    CPU %    MEM USAGE / LIMIT       MEM %
							proxy        0.59%    11.16 MiB / 3.858 GiB   0.28%

							```


						</script>
					</section>


					<section data-markdown>
						<script type="text/template">
							### Envoy Discovery (XDS)

							* Listener discovery service (LDS)
							* v1 Route discovery service (RDS)
							* Cluster discovery service (CDS)
							* Service discovery service (SDS)


						</script>
					</section>


					<section data-markdown>
						<script type="text/template">
							### See Envoy docs for more configuration

							[https://www.envoyproxy.io/docs/envoy/latest/intro/intro](https://www.envoyproxy.io/docs/envoy/latest/intro/intro)
						</script>
					</section>
				</section>


				<!--Istio service mesh------------------------------------------------------------------>
				<section>
					<section>
						<h3>Istio Service Mesh</h3>
						<div align="center">
							<img src="images/istiologo.png"/>
						</div>
					</section>
					<section>
						<h3>dropping in here</h3>
					</section>
				</section>



				<!--How did we get here------------------------------------------------------------------>
				<section>
					<section>
						<h3>Resilience</h3>
					</section>
					<section>
						<h3>dropping in here</h3>
					</section>
				</section>
				<section>
					<section>
						<h3>Routing</h3>
					</section>
					<section>
						<h3>dropping in here</h3>
					</section>
				</section>
				<section>
					<section>
						<h3>Observability</h3>
					</section>
					<section>
						<h3>dropping in here</h3>
					</section>
				</section>
				<section>
					<section>
						<h3>Chaos Testing</h3>
					</section>
					<section>
						<h3>dropping in here</h3>
					</section>
				</section>


			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				controls: true,
    			progress: true,
    			history: true,
    			// center: true,
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
